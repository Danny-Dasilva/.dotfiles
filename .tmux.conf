# ~/.tmux.conf

# --- 1. General Settings ---
set -g status-position top       # Move bar to the top
set -g base-index 1              # Start windows at 1 (VS Code style)
set -g pane-base-index 1
set -g mouse on                  # Enable mouse for scrolling/clicking
set -g renumber-windows on       # Auto-renumber windows when one is closed

# Terminal & color settings
set -g default-terminal "tmux-256color"
set -as terminal-features ",xterm-256color:RGB"
set -as terminal-overrides ',*:Smulx=\E[4::%p1%dm'  # Undercurl support
set -as terminal-overrides ',*:Setulc=\E[58::2::%p1%{65536}%/%d::%p1%{256}%/%{255}%&%d::%p1%{255}%&%d%;m'

# Performance settings
set -sg escape-time 0            # No delay after escape (critical for vim)
set -g focus-events on           # Enable focus events for vim/neovim
set -g history-limit 50000       # Increased scrollback

# Clipboard integration (OSC 52 - works over SSH)
set -g set-clipboard on
set -g allow-passthrough on

# Remap prefix from 'C-b' to 'C-y'
unbind C-b
set-option -g prefix C-y
bind-key C-y send-prefix

# --- 1a. Vi Copy Mode with Clipboard ---
setw -g mode-keys vi
bind -T copy-mode-vi v send -X begin-selection
bind -T copy-mode-vi C-v send -X rectangle-toggle
bind -T copy-mode-vi y send-keys -X copy-pipe-and-cancel 'xclip -selection clipboard'
bind -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-pipe-and-cancel 'xclip -selection clipboard'
bind -T copy-mode-vi / command-prompt -i -p "search down" "send -X search-forward-incremental \"%%%\""
bind -T copy-mode-vi ? command-prompt -i -p "search up" "send -X search-backward-incremental \"%%%\""

# --- 1b. Split panes (inherit current path) ---
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"
bind c new-window -c "#{pane_current_path}"
unbind '"'
unbind %

# --- 1c. Pane Navigation (Alt+hjkl) ---
bind -n M-h select-pane -L
bind -n M-l select-pane -R
bind -n M-k select-pane -U
bind -n M-j select-pane -D

# --- 1d. Window Switching (Alt+number, no prefix) ---
bind -n M-1 select-window -t 1
bind -n M-2 select-window -t 2
bind -n M-3 select-window -t 3
bind -n M-4 select-window -t 4
bind -n M-5 select-window -t 5
bind -n M-6 select-window -t 6
bind -n M-7 select-window -t 7
bind -n M-8 select-window -t 8
bind -n M-9 select-window -t 9

# --- 1e. Quick Toggles ---
bind Tab last-window             # Toggle last window
bind BTab switch-client -l       # Toggle last session
bind -n M-z resize-pane -Z       # Alt+z to zoom pane (no prefix)

# --- 1f. Pane Resizing (repeatable) ---
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5

# --- 1g. Pane Management ---
bind m select-pane -m \; display "Pane marked"
bind M select-pane -M \; display "Mark cleared"
bind y setw synchronize-panes \; display "Sync #{?pane_synchronized,ON,OFF}"

# Reload config
bind r source-file ~/.tmux.conf \; display "Reloaded tmux config!"

# --- 2. The SSH Project Menu ---
# Scans ~/.ssh/config. When selected, it connects and resumes the remote tmux session.
bind S run-shell 'tmux display-menu -x P -y P -T "#[fg=magenta,bold] 󱘖 Remote Workspaces " \
    $(grep -iP "^Host ([^*]+)$" ~/.ssh/config | awk "{print \$2}" | while read -r host; do \
        echo "\"$host\" \"$host\" \"new-window -n $host '\''ssh -t $host \\\"tmux new -A -s main\\\"'\''\""; \
    done) \
    "" \
    "󰜺 Close Menu" q ""'

# --- 3. Catppuccin Theme (must be before status customization) ---
set -g @catppuccin_flavor 'mocha'
set -g @catppuccin_window_status_style "rounded"
set -g @catppuccin_window_default_text " #W"
set -g @catppuccin_window_current_text " #W"

# Load catppuccin (manual method - more reliable than TPM for this plugin)
run ~/.tmux/plugins/tmux/catppuccin.tmux

# --- 4. Status Bar (after catppuccin loads) ---
set -g status-left "#[fg=#a6e3a1,bg=default] 󰐕 #[default]"
set -g status-right-length 100
set -g status-right "#[fg=#f9e2af]#(cd #{pane_current_path}; git branch --show-current 2>/dev/null | sed 's/.*/  & /')#[fg=#f38ba8,bg=default] 󰅖 #[default] #{E:@catppuccin_status_session}"

# --- 5. Plugins ---
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @plugin 'christoomey/vim-tmux-navigator'
set -g @plugin 'tmux-plugins/tmux-yank'        # Better clipboard integration
set -g @plugin 'sainnhe/tmux-fzf'              # Fuzzy find sessions/windows/panes
set -g @plugin 'laktak/extrakto'               # Extract URLs/paths from scrollback
set -g @plugin 'omerxx/tmux-sessionx'          # Session manager with preview
set -g @plugin 'fcsonline/tmux-thumbs'         # Vimium-style text hints

# Continuum settings
set -g @continuum-restore 'on'

# tmux-fzf settings
TMUX_FZF_LAUNCH_KEY="F"

# extrakto settings
set -g @extrakto_key "tab"

# tmux-sessionx settings
set -g @sessionx-bind 'o'
set -g @sessionx-preview-location 'right'
set -g @sessionx-preview-ratio '55%'

# tmux-thumbs settings
set -g @thumbs-key 'space'

# --- 5a. Popup Integrations ---
bind g display-popup -E -w 80% -h 80% -d "#{pane_current_path}" "lazygit"
bind G display-popup -E -w 80% -h 80% -d "#{pane_current_path}" "lazydocker"
bind t display-popup -E -w 80% -h 60% -d "#{pane_current_path}" "htop"

# --- 6. Clickable Status Bar ---
# Click + (left side) to create new window
bind -n MouseDown1StatusLeft new-window
# Click × (right side) to close current window
bind -n MouseDown1StatusRight confirm-before -p "Close window '#W'? (y/n)" kill-window
# Middle-click on any window tab to close it
bind -n MouseDown2Status kill-window

# --- 7. Help Menu (prefix + ?) ---
bind ? display-menu -T "#[fg=#cba6f7,bold]  Tmux Shortcuts " -x C -y C \
    "" \
    "#[fg=#a6e3a1,bold]─── Windows ───" "" "" \
    "  New Window          prefix + c" c "new-window -c '#{pane_current_path}'" \
    "  Close Window        prefix + &" & "confirm-before kill-window" \
    "  Next Window         prefix + n" n "next-window" \
    "  Prev Window         prefix + p" p "previous-window" \
    "  Last Window         prefix + Tab" Tab "last-window" \
    "  Switch (Alt+1-9)    Alt + 1-9" "" "" \
    "  Rename Window       prefix + ," , "command-prompt -I '#W' 'rename-window \"%%\"'" \
    "" \
    "#[fg=#89b4fa,bold]─── Panes ───" "" "" \
    "  Split Horizontal    prefix + |" | "split-window -h -c '#{pane_current_path}'" \
    "  Split Vertical      prefix + -" - "split-window -v -c '#{pane_current_path}'" \
    "  Close Pane          prefix + x" x "confirm-before kill-pane" \
    "  Zoom Pane           prefix + z (Alt+z)" z "resize-pane -Z" \
    "  Navigate            Alt + h/j/k/l" "" "" \
    "  Resize              prefix + H/J/K/L" "" "" \
    "  Mark Pane           prefix + m" m "select-pane -m" \
    "  Sync Panes          prefix + y" y "setw synchronize-panes" \
    "" \
    "#[fg=#f9e2af,bold]─── Sessions ───" "" "" \
    "  Session Picker      prefix + o" o "" \
    "  Last Session        prefix + BTab" BTab "switch-client -l" \
    "  SSH Menu            prefix + S" S "run-shell 'tmux display-menu -x P -y P -T \"#[fg=magenta,bold] 󱘖 Remote Workspaces \" \$(grep -iP \"^Host ([^*]+)\$\" ~/.ssh/config | awk \"{print \\\$2}\" | while read -r host; do echo \"\\\"\$host\\\" \\\"\$host\\\" \\\"new-window -n \$host '\\''ssh -t \$host \\\\\\\"tmux new -A -s main\\\\\\\"'\\''\\\"\" ; done) \"\" \"󰜺 Close Menu\" q \"\"'" \
    "  Save Session        prefix + Ctrl-s" C-s "run-shell '~/.tmux/plugins/tmux-resurrect/scripts/save.sh'" \
    "  Restore Session     prefix + Ctrl-r" C-r "run-shell '~/.tmux/plugins/tmux-resurrect/scripts/restore.sh'" \
    "  Detach              prefix + d" d "detach-client" \
    "" \
    "#[fg=#f38ba8,bold]─── Tools ───" "" "" \
    "  Lazygit             prefix + g" g "display-popup -E -w 80% -h 80% -d '#{pane_current_path}' lazygit" \
    "  LazyDocker          prefix + G" G "display-popup -E -w 80% -h 80% -d '#{pane_current_path}' lazydocker" \
    "  Htop                prefix + t" t "display-popup -E -w 80% -h 60% -d '#{pane_current_path}' htop" \
    "  Fuzzy Find          prefix + F" F "" \
    "  Extract Text        prefix + Tab" "" "" \
    "  Text Hints          prefix + Space" "" "" \
    "" \
    "#[fg=#89dceb,bold]─── Copy Mode ───" "" "" \
    "  Enter Copy          prefix + [" "[" "copy-mode" \
    "  Start Selection     v" "" "" \
    "  Rectangle Select    Ctrl + v" "" "" \
    "  Copy to Clipboard   y" "" "" \
    "  Search Down         /" "" "" \
    "  Search Up           ?" "" "" \
    "" \
    "#[fg=#6c7086]─── Mouse ───" "" "" \
    "  Click 󰐕             New window" "" "" \
    "  Click 󰅖             Close window" "" "" \
    "  Middle-click tab    Close that window" "" "" \
    "" \
    "#[fg=#cdd6f4,bold]─── Config ───" "" "" \
    "  Reload Config       prefix + r" r "source-file ~/.tmux.conf; display 'Reloaded!'" \
    "  Command Prompt      prefix + :" : "command-prompt" \
    "" \
    "󰜺 Close" q ""

# Initialize TPM (Keep this at the very bottom)
run '~/.tmux/plugins/tpm/tpm'

